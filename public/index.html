<!DOCTYPE html>
<!--
Copyright (c) 2016 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Cloud Messaging </title>

  <!-- Material Design Theming -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

  <link rel="stylesheet" href="main.css">

 
</head>
<body>
<div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">

  <!-- Header section containing title -->
  <header class="mdl-layout__header mdl-color-text--white mdl-color--light-blue-700">
    <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">
      <div class="mdl-layout__header-row mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--8-col-desktop">
        <h3>Firebase Cloud Messaging</h3>
      </div>
    </div>
  </header>

  <main class="mdl-layout__content mdl-color--grey-100">
    <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">

      <!-- Container for the Table of content -->
      <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">
        <div class="mdl-card__supporting-text mdl-color-text--grey-600">
          <!-- div to display the generated Instance ID token -->
          
              

          <div id="permission_div" style="display: none;">
            <h4>Needs Permission</h4>
            <p id="token"></p>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"
                    onclick="requestPermission()">Request Permission</button>
          </div>
          <!-- div to display messages received by this app. -->
          <div style="text-align:center;">

            <!-- Textfield with Floating Label -->

          <form action="#">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
              <input class="mdl-textfield__input" type="text" id="inputMsg">
              <label class="mdl-textfield__label" for="sample3">Text...</label>
            </div>
          </form>
 
 
              <button onclick=addText(); class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            Add
          </button>
          </form>
          </div>
          
          <div id="messages">

          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Import and configure the Firebase SDK -->
<!-- These scripts are made available when the app is served or deployed on Firebase Hosting -->
<!-- If you do not serve/host your project using Firebase Hosting see https://firebase.google.com/docs/web/setup -->
<script src="/__/firebase/3.9.0/firebase-app.js"></script>
<script src="/__/firebase/3.9.0/firebase.js"></script>
<script src="/__/firebase/init.js"></script>
<script
  src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
  crossorigin="anonymous"></script>
 
<script src="/firebase-messageing-sw.js" type="text/javasctipt"></script>


<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDHQxlgQ7hXW8m6okxMQHjmUxKtEwcdUc0",
    authDomain: "chatter-f3d2d.firebaseapp.com",
    databaseURL: "https://chatter-f3d2d.firebaseio.com",
    projectId: "chatter-f3d2d",
    storageBucket: "chatter-f3d2d.appspot.com",
    messagingSenderId: "659586777397"
  };
  firebase.initializeApp(config);
  


</script>
<script>
  // [START get_messaging_object]
  // Retrieve Firebase Messaging object.
  const messaging = firebase.messaging();
 
function addText(){
  var rootRef = firebase.database().ref();
  var storesRef = rootRef.child('chat/room1');
  var newStoreRef = storesRef.push();
  
  let txtMsg  = document.getElementById("inputMsg").value;
  
  let id = "00001";

  
  appendMessage(txtMsg);
  
  
  newStoreRef.set({
    uid: id,
    "nickname": "Tae",
    "message": txtMsg,
    "timestamp": $.now()
  });
}

function Uppic(Title,image){


}


function GET_Permission() {
  messaging.requestPermission()
  .then(function() {
  console.log("Notification permission granted.");
   // TODO(developer): Retrieve a Instance ID token for use with FCM.
   // …
  })
  .catch(function(err) {
   console.log("Unable to get permission to notify. ", err);
  });
 }


  // [START receive_message]
  // Handle incoming messages. Called when:
  // - a message is received while the app has focus
  // - the user clicks on an app notification created by a sevice worker
  //   `messaging.setBackgroundMessageHandler` handler.
  messaging.onMessage(function(payload) {
    console.log("Message received. ", payload);
    // [START_EXCLUDE]
    // Update the UI to include the received message.
    appendMessage(payload);
    // [END_EXCLUDE]
  });
  // [END receive_message]


  function showToken() {
 // Get Instance ID token. Initially this makes a network call, once retrieved
 // subsequent calls to getToken will return from cache.
 messaging.getToken()
 .then(function(currentToken) {
  if (currentToken) {
   console.log("currentToken", currentToken);
   //$("#token").html(currentToken);
  } else {
   // Show permission request.
   console.log("No Instance ID token available. Request permission to generate one.");
  // $("#token").html("foo");
  }
 })
 .catch(function(err) {
  console.log("An error occurred while retrieving token. ", err);
 });
}
messaging.onTokenRefresh(function() {
 messaging.getToken()
 .then(function(refreshedToken) {
  console.log("Token refreshed.");
  //$(“#token”).html(refreshedToken);
 })
 .catch(function(err) {
  console.log("Unable to retrieve refreshed token ", err);
 });
});
 

 messaging.onMessage(function(payload) {
 console.log("Message received. ", payload);
});


  function showHideDiv(divId, show) {
    const div = document.querySelector('#' + divId);
    if (show) {
      div.style = "display: visible";
    } else {
      div.style = "display: none";
    }
  }


  // Add a message to the messages element.
  function appendMessage(payload) {
    const messagesElement = document.querySelector('#messages');
    const dataHeaderELement = document.createElement('h5');
    const dataElement = document.createElement('pre');
    dataElement.style = 'overflow-x:hidden;'
    dataHeaderELement.textContent = 'Received message:';
    dataElement.textContent = JSON.stringify(payload, null, 2);
    messagesElement.appendChild(dataHeaderELement);
    messagesElement.appendChild(dataElement);
  }



  function checkConnection() {
        
        try {
             firebase.checkConnection();
         
            firebase.InitData();
        } catch (error) {
            console.log('Data Service error:' + error);
        }
    }
 


  // Clear the messages element of all children.
  function clearMessages() {
    const messagesElement = document.querySelector('#messages');
    while (messagesElement.hasChildNodes()) {
      messagesElement.removeChild(messagesElement.lastChild);
    }
  }

  function updateUIForPushEnabled(currentToken) {
    showHideDiv(tokenDivId, true);
    showHideDiv(permissionDivId, false);
    showToken(currentToken);
  }

  function updateUIForPushPermissionRequired() {
    showHideDiv(tokenDivId, false);
    showHideDiv(permissionDivId, true);
  }

  //resetUI();
</script>
</body>
</html>