<!DOCTYPE html>
<!--
Copyright (c) 2016 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Cloud Messaging </title>

  <!-- Material Design Theming -->

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

  <link rel="stylesheet" href="main.css" type="text/css">
   <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue-indigo.min.css" /> 
 
</head>
<body>

  
 <!--   login   Div  -->


<dialog class="mdl-dialog">
    <div class="mdl-dialog__content">
      <p>
             <!-- <a href="#"onclick="firebase.auth().signInWithPopup(provider)">LOGIN</a> -->
      </p>
    </div>

     <div class="mdl-dialog__actions mdl-dialog__actions--full-width">

        <div class="mdl-dialog__actions mdl-dialog__actions--full-width">
      <button type="button" class="mdl-button fblogin">Login</button>
      <button type="button" class="mdl-button close">Cancel</button>
    </div>


    </div>

    
  </dialog>


 <!--    End login    -->








<!-- Simple header with fixed tabs. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header  
            mdl-layout--fixed-tabs">
  <header class="mdl-layout__header ">
    <div class="mdl-layout__header-row">
      <!-- Title -->
      <span class="mdl-layout-title">Firebase Cloud Messaging</span>
    </div>
    <!-- Tabs -->
    <div class="mdl-layout__tab-bar mdl-js-ripple-effect  ">
      <a href="#fixed-tab-1" class="mdl-layout__tab is-active">Chat</a>
      <a href="#fixed-tab-2" class="mdl-layout__tab">Room</a>
      <a href="#fixed-tab-3" class="mdl-layout__tab">Setting</a>
    </div>
  </header>
  <div class="mdl-layout__drawer">
    <span class="mdl-layout-title">User:    

      <img id="imavatar"  src="#">
      <br>
     <span class="mdl-layout-title" id="uname">    
    </span>
  </div>
  <main class="mdl-layout__content">
    <section class="mdl-layout__tab-panel is-active" id="fixed-tab-1">
      <div class="page-content"><!-- Your content goes here -->
      
       <div class="mdl-dialog__actions mdl-dialog__actions--full-width">

        <div class="mdl-dialog__actions mdl-dialog__actions--full-width">
      <button type="button" class="mdl-button" onclick="ShowLogin()">FaceBook</button>
       
    </div>

        
      
      
      
      
      
      
      
      <div class="mdl-shadow--2dp chatBox">
      

          <div id="messages">

          </div>


        <div class="mdl-card__actions mdl-card--border">
    <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
     
 
      

    </a>
  </div>
  <div class="mdl-card__menu">
    <button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
      <i class="material-icons">share</i>
      
    </button>
  </div>
</div>


      
   <footer class="SendBox ">
     <div style="margin:auto">
       <form  action="#">

              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:80%">
                <input class="mdl-textfield__input" type="text" id="inputMsg"  onkeydown="if (event.keyCode == 13) {  sendText();} "  >
                <label class="mdl-textfield__label" for="sample3">Type Here...</label>
         
              </div>
              <button onclick=sendText(); class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
              SEND
            </button>
            </form>
              </div>
  </footer>
  
  
      
      <!-- PAGE 1 -->
      </div>
    </section>
    <section class="mdl-layout__tab-panel" id="fixed-tab-2">
      <div class="page-content"><!-- Your content goes here --></div>
    </section>
    <section class="mdl-layout__tab-panel" id="fixed-tab-3">
      <div class="page-content"><!-- Your content goes here --></div>
    </section>
  </main>
</div>


</body>

<style>

  /*
<div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">

  <!-- Header section containing title -->
  <header class="mdl-layout__header mdl-color-text--white mdl-color--light-blue-700">
    <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">
      <div class="mdl-layout__header-row mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--8-col-desktop">
        <h3> Cloud Messaging</h3>
      </div>

<!-- Right aligned menu below button -->
<button id="demo-menu-lower-right"
        class="mdl-button mdl-js-button mdl-button--icon">
  <i class="material-icons">more_vert</i>
</button>

<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"
    for="demo-menu-lower-right">
  <li class="mdl-menu__item">Some Action</li>
  <li class="mdl-menu__item">Another Action</li>
  <li disabled class="mdl-menu__item">Disabled Action</li>
  <li class="mdl-menu__item">Yet Another Action</li>
</ul>

    </div>

    

    
  </header>

  <main class="mdl-layout__content mdl-color--grey-100">
    <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">

      <!-- Container for the Table of content -->
      <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">
        <div class="mdl-card__supporting-text mdl-color-text--grey-600">
          <!-- div to display the generated Instance ID token -->
          
              

          <div id="permission_div" style="display: none;">
            <h4>Needs Permission</h4>
            <p id="token"></p>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"
                    onclick="requestPermission()">Request Permission</button>
          </div>
          <!-- div to display messages received by this app. -->
          <div style="text-align:center;">

            <!-- Textfield with Floating Label -->

            <form action="#">
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" type="text" id="inputMsg">
                <label class="mdl-textfield__label" for="sample3">Text...</label>
              </div>
            </form>
  
  
                <button onclick=sendText(); class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
              Add
            </button>
            </form>
          </div>
          
          <div id="messages">

          </div>
        </div>
      </div>

    </div>
  </main>
</div>

*/


</style>
<!-- Import and configure the Firebase SDK -->
<!-- These scripts are made available when the app is served or deployed on Firebase Hosting -->
<!-- If you do not serve/host your project using Firebase Hosting see https://firebase.google.com/docs/web/setup -->
<script src="/__/firebase/3.9.0/firebase-app.js"></script>
<script src="/__/firebase/3.9.0/firebase.js"></script>
<script src="/__/firebase/init.js"></script>
<script
  src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
  crossorigin="anonymous"></script>
 
<script src="/firebase-messageing-sw.js" type="text/javasctipt"></script>



<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDHQxlgQ7hXW8m6okxMQHjmUxKtEwcdUc0",
    authDomain: "chatter-f3d2d.firebaseapp.com",
    databaseURL: "https://chatter-f3d2d.firebaseio.com",
    projectId: "chatter-f3d2d",
    storageBucket: "chatter-f3d2d.appspot.com",
    messagingSenderId: "659586777397"
  };
  firebase.initializeApp(config);
  let  name ,email,photoUrl,uid;

  // Innitialize FaceBook
var provider = new firebase.auth.FacebookAuthProvider();
    //provider.addScope('user_birthday');
 provider.addScope('user_birthday');
 
 // Check Logion State

firebase.auth().onAuthStateChanged(function(user) {
  console.log("onAuthStateChanged");
  if (user) {
    // User is signed in.  Refresh
      name = user.displayName;
      email = user.email;
      photoUrl = user.photoURL;
      uid = user.uid;  
    resetUI();
  } else {
    ShowLogin();
  }
});

 




function resetUI( ){

var user = firebase.auth().currentUser;

 $("#imavatar").attr("src",user.photoURL);
 $("#uname").text(user.displayName);

 }


function CreateNewUser(){

var user = firebase.auth().currentUser;

if (user) {
  // User is signed in.



 
if (user != null) {
  name = user.displayName;
  email = user.email;
  photoUrl = user.photoURL;
  uid = user.uid;  // The user's ID, unique to the Firebase project. Do NOT use
                   // this value to authenticate with your backend server, if
                   // you have one. Use User.getToken() instead.
writeUserData(uid, name, email, photoUrl);
 
  console.log(name);
  console.log(email);
  console.log(photoUrl);
  console.log("UID :"+uid);
}
} else {
  // No user is signed in.
  console.log("User not login")
  ShowLogin();
}
}


 function debug(){
//firebase.auth().currentUse.accessToken.querySelector(email)
   console.log(name);
 }
 
  // MODAL
  
 
    var dialog = document.querySelector('dialog');
    var showModalButton = document.querySelector('.show-modal');
    if (! dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
    }
    dialog.querySelector('.fblogin').addEventListener('click', function() {
      firebase.auth().signInWithPopup(provider);
      debug();
      dialog.close();
      CreateNewUser();
    });
    dialog.querySelector('.close').addEventListener('click', function() {
      dialog.close();
    });
  

  function ShowLogin(){
    dialog.showModal();
  }
 //MODAL

// FB 
 
 
// End Fb
function getLastMessage() {
   refMessages.limitToLast(1).on('child_added', function (snapshot) 
   {
       var data = snapshot.val();
       $('#hf_lastfid').val(data.fbid);
       $('#hf_lastdir').val(data.dir);
   });
}


newPostKey = firebase.database().ref()

function getPost(){


var ref = firebase.database().ref("chat/room1/");
ref.orderByKey().limitToLast(50).on("child_added", function(snapshot) {
  console.log(snapshot.key);
  console.log(snapshot.val().message);
  console.log(snapshot.val().uid);
  console.log();
});

}

function listin(){


  var ref = firebase.database().ref("chat/room1/");

  ref.on('child_added', function(childSnapshot, prevChildKey) {
   
});
}



  // [START get_messaging_object]
  // Retrieve Firebase Messaging object.
  const messaging = firebase.messaging();
 
function sendText(){


  var rootRef = firebase.database().ref();
  var storesRef = rootRef.child('chat/room1');
  var newStoreRef = storesRef.push();
  
  let txtMsg  = document.getElementById("inputMsg").value;
   if(txtMsg==null||txtMsg==""){return}

var sendtData = {
    uid: uid,
    name:name,
    message: txtMsg,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  };



  document.getElementById("inputMsg").value="";



  var newPostKey = firebase.database().ref().child('chat').child('room1').push().key;

  // Write the new post's data simultaneously in the posts list and the user's post list.
  var updates = {};
  updates['/chat/'+'room1/' + newPostKey] = sendtData;

   appendMessage(txtMsg);
  return firebase.database().ref().update(updates);


}


function writeNewPost(uid, username, picture, title, body) {
  // A post entry.
  var postData = {
    author: username,
    uid: uid,
    body: body,
    title: title,
    starCount: 0,
    authorPic: picture
  };}

function Uppic(Title,image){


}


function GET_Permission() {
  messaging.requestPermission()
  .then(function() {
  console.log("Notification permission granted.");
   // TODO(developer): Retrieve a Instance ID token for use with FCM.
   // …
  })
  .catch(function(err) {
   console.log("Unable to get permission to notify. ", err);
  });
 }


  // [START receive_message]
  // Handle incoming messages. Called when:
  // - a message is received while the app has focus
  // - the user clicks on an app notification created by a sevice worker
  //   `messaging.setBackgroundMessageHandler` handler.
  messaging.onMessage(function(payload) {
    console.log("Message received. ", payload);
    // [START_EXCLUDE]
    // Update the UI to include the received message.
    appendMessage(payload);
    // [END_EXCLUDE]
  });
  // [END receive_message]


  function showToken() {
 // Get Instance ID token. Initially this makes a network call, once retrieved
 // subsequent calls to getToken will return from cache.
 messaging.getToken()
 .then(function(currentToken) {
  if (currentToken) {
   console.log("currentToken", currentToken);
   //$("#token").html(currentToken);
  } else {
   // Show permission request.
   console.log("No Instance ID token available. Request permission to generate one.");
  // $("#token").html("foo");
  }
 })
 .catch(function(err) {
  console.log("An error occurred while retrieving token. ", err);
 });
}
messaging.onTokenRefresh(function() {
 messaging.getToken()
 .then(function(refreshedToken) {
  console.log("Token refreshed.");
  //$(“#token”).html(refreshedToken);
 })
 .catch(function(err) {
  console.log("Unable to retrieve refreshed token ", err);
 });
});
 

 messaging.onMessage(function(payload) {
 console.log("Message received. ", payload);
});


  function showHideDiv(divId, show) {
    const div = document.querySelector('#' + divId);
    if (show) {
      div.style = "display: visible";
    } else {
      div.style = "display: none";
    }
  }


  // Add a message to the messages element.
  function appendMessage(payload) {
    const messagesElement = document.querySelector('#messages');
    const dataHeaderELement = document.createElement('h5');
    const dataElement = document.createElement('pre');
    dataElement.style = 'overflow-x:hidden;'
    dataHeaderELement.textContent = 'Received message:';
    dataElement.textContent = JSON.stringify(payload, null, 2);
    messagesElement.appendChild(dataHeaderELement);
    messagesElement.appendChild(dataElement);
  }


// ADD USER DATA
function writeUserData(userId, name, email, avatar) {
  firebase.database().ref('users/' + userId).set({
    username: name,
    email: email,
    profile_picture : avatar,
  });
}


function writeNewPost(uid, username, picture, title, body) {
  // A post entry.
  var postData = {
    author: username,
    uid: uid,
    body: body,
    title: title,
    starCount: 0,
    authorPic: picture
  };

  // Get a key for a new Post.
  var newPostKey = firebase.database().ref().child('posts').push().key;

  // Write the new post's data simultaneously in the posts list and the user's post list.
  var updates = {};
  updates['/posts/' + newPostKey] = postData;
  updates['/user-posts/' + uid + '/' + newPostKey] = postData;

  return firebase.database().ref().update(updates);
}

  function checkConnection() {
        
        try {
             firebase.checkConnection();
         
            firebase.InitData();
        } catch (error) {
            console.log('Data Service error:' + error);
        }
    }
 


  // Clear the messages element of all children.
  function clearMessages() {
    const messagesElement = document.querySelector('#messages');
    while (messagesElement.hasChildNodes()) {
      messagesElement.removeChild(messagesElement.lastChild);
    }
  }

  function updateUIForPushEnabled(currentToken) {
    showHideDiv(tokenDivId, true);
    showHideDiv(permissionDivId, false);
    showToken(currentToken);
  }

  function updateUIForPushPermissionRequired() {
    showHideDiv(tokenDivId, false);
    showHideDiv(permissionDivId, true);
  }
 
  //resetUI();
</script>
</body>
</html>